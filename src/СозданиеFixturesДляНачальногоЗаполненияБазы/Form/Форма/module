
Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Функция ПолучитьМассивКонстантДляОбработки()
	Массив = Новый Массив;
	
	Для каждого Элем Из Метаданные.Константы Цикл
		//Сообщить(Элем);
		Имя         = Элем.Имя;
		Массив.Добавить(Имя);
	КонецЦикла;
	
	Возврат Массив;
КонецФункции	

Функция ПолучитьСтрокуДляСтруктуры(Структура,ТаблицаСправочниковДляПолученияМакетовFixtures)
	
	Сообщить(" ");
	Сообщить("ОбъектДляХранилищаЗначения = Новый Структура;");
	Для каждого Элем Из Структура Цикл
		Ключ     = Элем.Ключ;
		Значение = Элем.Значение;
		Если Значение = Неопределено Тогда
			Сообщить("ОбъектДляХранилищаЗначения.Вставить(""" + Ключ + """,Неопределено);");
			Продолжить;
		КонецЕсли;	 
		
		СтрокаЗначения = ПолучитьСтрокуДляЗначения(Значение,"",ТаблицаСправочниковДляПолученияМакетовFixtures);
		Сообщить("ОбъектДляХранилищаЗначения.Вставить(""" + Ключ + """," + СтрокаЗначения + ");");
	КонецЦикла;
	Сообщить("ОбъектДляХранилищаЗначения = Новый ХранилищеЗначения(ОбъектДляХранилищаЗначения);");
	Возврат "//Была создана структура";
КонецФункции	

Функция ПолучитьДатуСтрокой(Дат)
	Возврат "'" + Формат(Дат,"ДФ=yyyyMMdd") + Формат(Дат,"ДФ=HHmmss") + "'";
КонецФункции	

Процедура ДобавитьОбъектВТаблицу(ТаблицаОбъектов,Объект,Тип,Вид)
	Если Не ЗначениеЗаполнено(Объект) Тогда
		Возврат;
	КонецЕсли;	 
	
	СтрТаблицаОбъектов        = ТаблицаОбъектов.Добавить();
	СтрТаблицаОбъектов.Объект = Объект;
	СтрТаблицаОбъектов.Тип    = Тип;
	СтрТаблицаОбъектов.Вид    = Вид;
КонецПроцедуры

Функция ПолучитьСтрокуДляЗначения(Значение,ИмяКонстанты = "",ТаблицаСправочников);
	ТипЗначения = ТипЗнч(Значение);
	
	Если ТипЗначения = Тип("Строка") Тогда
		Возврат """" + Значение + """";
	ИначеЕсли ТипЗначения = Тип("Число") Тогда
		Возврат СтрЗаменить(СтрЗаменить(Значение,",","."),Символы.НПП,"");
		
	ИначеЕсли ТипЗначения = Тип("Булево") Тогда
		Если Значение Тогда
			Возврат "Истина";
		Иначе	
			Возврат "Ложь";
		КонецЕсли;	 
	ИначеЕсли ТипЗначения = Тип("Дата") Тогда
		//Возврат "'" + Формат(Значение,"ДФ=yyyyMMdd") + Формат(Значение,"ДФ=HHmmss") + "'";
		Возврат ПолучитьДатуСтрокой(Значение);
		
	ИначеЕсли Справочники.ТипВсеСсылки().СодержитТип(ТипЗначения) Тогда
		ИмяМетаданного    = Значение.Метаданные().Имя;
		ДлинаКода         = Значение.Метаданные().ДлинаКода;
		ДлинаНаименования = Значение.Метаданные().ДлинаНаименования;
		
		ДобавитьОбъектВТаблицу(ТаблицаСправочников,Значение,"Справочник",ИмяМетаданного);
		
		Если ДлинаКода > 0 Тогда
			Если Значение.Метаданные().ТипКода = Метаданные.СвойстваОбъектов.ТипКодаСправочника.Число Тогда
				Возврат "ПолучитьСправочникПоРеквизиту(""" + ИмяМетаданного + """,""Код""," + СтрЗаменить(СокрЛП(Значение.Код),Символы.НПП,"") + ")";
			Иначе	
				Возврат "ПолучитьСправочникПоРеквизиту(""" + ИмяМетаданного + """,""Код"",""" + СокрЛП(Значение.Код) + """)";
			КонецЕсли;	 
		ИначеЕсли ДлинаНаименования > 0 Тогда
			Возврат "ПолучитьСправочникПоРеквизиту(""" + ИмяМетаданного + """,""Наименование"",""" + СокрЛП(Значение.Наименование) + """)";
		Иначе
			Возврат Неопределено;
			//Сообщить("//Константа " + Имя + ". Не смог определить как заплонять значение.");
		КонецЕсли;	 
	ИначеЕсли Документы.ТипВсеСсылки().СодержитТип(ТипЗначения) Тогда
		ИмяМетаданного    = Значение.Метаданные().Имя;
		ТипНомера         = Значение.Метаданные().ТипНомера;
		ДлинаНомера       = Значение.Метаданные().ДлинаНомера;
		Если ДлинаНомера > 0 Тогда
			Если Значение.Метаданные().ТипНомера = Метаданные.СвойстваОбъектов.ТипНомераДокумента.Число Тогда
				Возврат "ПолучитьДокументПоНомеру(""" + ИмяМетаданного + """," + СтрЗаменить(СокрЛП(Значение.Номер),Символы.НПП,"") + "," + ПолучитьДатуСтрокой(Значение.Дата) + ")";
			Иначе	
				Возврат "ПолучитьДокументПоНомеру(""" + ИмяМетаданного + """,""" + СокрЛП(Значение.Номер) + """," + ПолучитьДатуСтрокой(Значение.Дата) + ")";
			КонецЕсли;	 
		Иначе	
			Возврат "ПолучитьДокументПоНомеру(""" + ИмяМетаданного + """,""" + "" + """," + ПолучитьДатуСтрокой(Значение.Дата) + ")";
			//Сообщить("//Константа " + Имя + ". Не смог определить как заплонять значение.");
		КонецЕсли;	 
	ИначеЕсли Перечисления.ТипВсеСсылки().СодержитТип(ТипЗначения) Тогда
		ИмяМетаданного    = Значение.Метаданные().Имя;
		ИндексЗначенияПеречисления = Перечисления[ИмяМетаданного].Индекс(Значение);
		ИмяЗначенияПеречисления = Метаданные.Перечисления[ИмяМетаданного].ЗначенияПеречисления[ИндексЗначенияПеречисления].Имя;
		
		Возврат "Перечисление." + ИмяМетаданного + "." + ИмяЗначенияПеречисления;
	ИначеЕсли ТипЗначения = Тип("ХранилищеЗначения") Тогда
		ЗначениеИзХранилища = Значение.Получить();
		Если ЗначениеИзХранилища = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;	
		
		ТипЗначенияИзХранилища = ТипЗнч(ЗначениеИзХранилища);
		Если ТипЗначенияИзХранилища = Тип("Структура") Тогда
			Возврат ПолучитьСтрокуДляСтруктуры(ЗначениеИзХранилища,ТаблицаСправочников);
		КонецЕсли;	 
		
		//Сообщить("ХранилищеЗначения");
		//ПолучитьСтрокуКодаДляЗначения(ЗначениеИзХранилища,Имя)
		Если ИмяКонстанты <> "" Тогда
			Сообщить("//Здесь надо заполнить константу " + ИмяКонстанты + " в которой хранилище значения. ТипЗначенияИзХранилища="+ТипЗначенияИзХранилища);
		КонецЕсли;	 
		Возврат Неопределено;
	Иначе
		//Сообщить("//Здесь надо установить значение для константы """ + Имя + """. ТипЗначения="+ТипЗначения);
		Возврат Неопределено;
	КонецЕсли;	 
КонецФункции	

Процедура ПолучитьСтрокуКодаДляЗначения(Значение,Имя,ТаблицаСправочниковДляПолученияМакетовFixtures)
		ТипЗначения = ТипЗнч(Значение);
		
		
		СтрокаДляЗначения = ПолучитьСтрокуДляЗначения(Значение,Имя,ТаблицаСправочниковДляПолученияМакетовFixtures);
		Если СтрокаДляЗначения = Неопределено Тогда
			Сообщить("//Здесь надо установить значение для константы """ + Имя + """. ТипЗначения="+ТипЗначения);
		ИначеЕсли ТипЗначения = Тип("ХранилищеЗначения") Тогда
			Сообщить("Константа." + Имя + ".Установить(" + "ОбъектДляХранилищаЗначения" + ");");
			Сообщить(" ");
		Иначе
			Сообщить("Константа." + Имя + ".Установить(" + СтрокаДляЗначения + ");");
			Сообщить(" ");
		КонецЕсли;	 
		
		//Если ТипЗначения = Тип("Строка") Тогда
		//	Сообщить("Константа." + Имя + ".Установить(""" + Значение + """);");
		//ИначеЕсли ТипЗначения = Тип("Число") Тогда
		//	Сообщить("Константа." + Имя + ".Установить(" + СтрЗаменить(Значение,",",".") + ");");
		//ИначеЕсли ТипЗначения = Тип("Булево") Тогда
		//	Если Значение Тогда
		//		Сообщить("Константа." + Имя + ".Установить(" + "Истина" + ");");
		//	Иначе	
		//		Сообщить("Константа." + Имя + ".Установить(" + "Ложь" + ");");
		//	КонецЕсли;	 
		//ИначеЕсли ТипЗначения = Тип("Дата") Тогда
		//	Сообщить("Константа." + Имя + ".Установить('" + Формат(Значение,"ДФ=yyyyMMdd") + Формат(Значение,"ДФ=HHmmss") + "');");
		//ИначеЕсли Справочники.ТипВсеСсылки().СодержитТип(ТипЗначения) Тогда
		//	ИмяМетаданного    = Значение.Метаданные().Имя;
		//	ДлинаКода         = Значение.Метаданные().ДлинаКода;
		//	ДлинаНаименования = Значение.Метаданные().ДлинаНаименования;
		//	Если ДлинаКода > 0 Тогда
		//		Если Значение.Метаданные().ТипКода = Метаданные.СвойстваОбъектов.ТипКодаСправочника.Число Тогда
		//			Сообщить("Константа." + Имя + ".Установить(ПолучитьСправочникПоРеквизиту(""" + ИмяМетаданного + """,""Код""," + Значение.Код + "));");
		//		Иначе	
		//			Сообщить("Константа." + Имя + ".Установить(ПолучитьСправочникПоРеквизиту(""" + ИмяМетаданного + """,""Код"",""" + Значение.Код + """));");
		//		КонецЕсли;	 
		//	ИначеЕсли ДлинаНаименования > 0 Тогда
		//		Сообщить("Константа." + Имя + ".Установить(ПолучитьСправочникПоРеквизиту(""" + ИмяМетаданного + """,""Наименование"",""" + Значение.Наименование + """));");
		//	Иначе
		//		Сообщить("//Константа " + Имя + ". Не смог определить как заплонять значение.");
		//	КонецЕсли;	 
		//ИначеЕсли Перечисления.ТипВсеСсылки().СодержитТип(ТипЗначения) Тогда
		//	ИмяМетаданного    = Значение.Метаданные().Имя;
		//	ИндексЗначенияПеречисления = Перечисления[ИмяМетаданного].Индекс(Значение);
		//	ИмяЗначенияПеречисления = Метаданные.Перечисления[ИмяМетаданного].ЗначенияПеречисления[ИндексЗначенияПеречисления].Имя;
		//	Сообщить("Константа." + Имя + ".Установить(Перечисление." + ИмяМетаданного + "." + ИмяЗначенияПеречисления + ");");
		//ИначеЕсли ТипЗначения = Тип("ХранилищеЗначения") Тогда
		//	ЗначениеИзХранилища = Значение.Получить();
		//	Если ЗначениеИзХранилища = Неопределено Тогда
		//		Сообщить("//Константа " + Имя + " была не заполнена.");
		//		Возврат;
		//	КонецЕсли;	 
		//	
		//	Сообщить("ХранилищеЗначения");
		//	ПолучитьСтрокуКодаДляЗначения(ЗначениеИзХранилища,Имя)
		//Иначе
		//	Сообщить("//Здесь надо установить значение для константы """ + Имя + """. ТипЗначения="+ТипЗначения);
		//КонецЕсли;	 
КонецПроцедуры


Процедура кнГенерацияДанныхДляКонстантНажатие(Элемент)
	ФайлМакета = Новый Файл(ПутьУПустомуПравильномуМакету);
	Если Не ФайлМакета.Существует() Тогда
		Сообщить("Файл макета " + ПутьУПустомуПравильномуМакету + " не найден!");
		Возврат;
	КонецЕсли;	 
	
	
	МассивКонстантДляОбработки = ПолучитьМассивКонстантДляОбработки();
	
	ТаблицаСправочниковДляПолученияМакетовFixtures = Новый ТаблицаЗначений;
	ТаблицаСправочниковДляПолученияМакетовFixtures.Колонки.Добавить("Объект");
	ТаблицаСправочниковДляПолученияМакетовFixtures.Колонки.Добавить("Тип");
	ТаблицаСправочниковДляПолученияМакетовFixtures.Колонки.Добавить("Вид");
	
	Сообщить("//код для вставки");
	Для каждого Элем Из МассивКонстантДляОбработки Цикл
		Имя         = Элем;
		Значение    = Константы[Имя].Получить();
		Если НЕ ЗначениеЗаполнено(Значение) Тогда
			Сообщить("//Константа " + Имя + " была не заполнена.");
			Продолжить;
		КонецЕсли;	 
		
		
		ТипЗначения = ТипЗнч(Значение);
		Если ТипЗначения = Тип("ХранилищеЗначения") Тогда
			ЗначениеИзХранилища = Значение.Получить();
			Если ЗначениеИзХранилища = Неопределено Тогда
				Сообщить("//Константа " + Имя + " была не заполнена.");
				Продолжить;
			КонецЕсли;	
		КонецЕсли;	 
		
		ПолучитьСтрокуКодаДляЗначения(Значение,Имя,ТаблицаСправочниковДляПолученияМакетовFixtures);
	КонецЦикла;
	
	
	ТаблицаСправочниковДляПолученияМакетовFixtures.Свернуть("Объект,Тип,Вид");
	ТаблицаСправочниковДляПолученияМакетовFixtures.Сортировать("Вид,Объект");
	
	
	//ТаблицаСправочниковДляПолученияМакетовFixtures.ВыбратьСтроку();
	Сообщить("   ");
	
	
	
	
	//СтрСтрока = ТаблицаСправочниковДляПолученияМакетовFixtures.Добавить();
	//СтрСтрока.Объект = Справочники.Номенклатура.НайтиПоКоду("00000001350");
	//СтрСтрока.Тип    = "Справочник";
	//СтрСтрока.Вид    = "Номенклатура";
	
	ПолучитьFixturesДляСправочников(ТаблицаСправочниковДляПолученияМакетовFixtures);
	
КонецПроцедуры


Функция ПолучитьТаблицуВидовСправочников(ТаблицаОбъектов)
	КопияТаблицы = ТаблицаОбъектов.Скопировать();
	
	КопияТаблицы.Свернуть("Вид");
	КопияТаблицы.Сортировать("Вид");
	
	Возврат КопияТаблицы;
КонецФункции	


Функция ПолучитьМакетДляВидаСправочника(Вид,ВсяТаблицаОбъектов)
	Отбор = Новый Структура();
	Отбор.Вставить("Вид",Вид);
	МассивСтрок = ВсяТаблицаОбъектов.НайтиСтроки(Отбор);
	
	СтруктураПараметров = Новый Структура;
	
	МассивОбъектов = Новый Массив;
	
	Для каждого СтрокаСОбъектов Из МассивСтрок Цикл
		//Сообщить("" + СтрокаСОбъектов.Объект + ", Вид="+СтрокаСОбъектов.Вид);
		
		СтруктураОбъекта = Новый Структура;
		СтруктураОбъекта.Вставить("Объект",СтрокаСОбъектов.Объект);
		СтруктураОбъекта.Вставить("Вид",СтрокаСОбъектов.Вид);
		
		МассивОбъектов.Добавить(СтруктураОбъекта);
		
	КонецЦикла;
	
	СтруктураПараметров.Вставить("МассивОбъектов",МассивОбъектов);
	
	
	
	ГенераторFixtures = ВнешниеОбработки.Создать(ПутьКГенераторуFixtures);
	ФормаГенератора   = ГенераторFixtures.ПолучитьФорму("Форма");
	ФормаГенератора.Открыть();
	ГенераторFixtures.ВыгружатьКод = Истина;
	
	ДеревоМетаданных = ГенераторFixtures.ДеревоМетаданных;
	//ДеревоМетаданных.ВыбратьСтроку();
	
	ВеткаСправочников = ДеревоМетаданных.Строки[0].Строки[0];
	//Для каждого СтрокаДерева Из ВеткаСправочников.Строки Цикл
	//	Сообщить("" + СтрокаДерева.ПолноеИмяМетаданных);
	//КонецЦикла;
	НужнаяСтрокаДерева = ВеткаСправочников.Строки.Найти(Вид,"ПолноеИмяМетаданных");
	Если НужнаяСтрокаДерева = Неопределено Тогда
		Сообщить("Не найдена строка справочника в дереве. Вид="+вид);
		Возврат Неопределено;
	КонецЕсли;	 
	
	
	НужнаяСтрокаДерева.Выгружать         = Истина;
	НужнаяСтрокаДерева.ИспользоватьОтбор = Истина;
	
	
	
	ФормаГенератора.ЭлементыФормы.ДеревоМетаданных.ТекущаяСтрока = НужнаяСтрокаДерева;
	//ФормаГенератора.ДеревоМетаданныхПриАктивизацииСтроки("");
	
	
	ЭлементОтбора                = ГенераторFixtures.КомпоновщикНастроекКомпоновкиДанных.Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение  = Новый ПолеКомпоновкиДанных("Ссылка");
	ЭлементОтбора.ВидСравнения   = ВидСравненияКомпоновкиДанных.ВСписке;
	
	СпсЗначений = Новый СписокЗначений;
	СпсЗначений.ЗагрузитьЗначения(ВсяТаблицаОбъектов.ВыгрузитьКолонку("Объект"));
	ЭлементОтбора.ПравоеЗначение = СпсЗначений;
	
	ЭлементОтбора.Использование = Истина;
	
	НужнаяСтрокаДерева.НастройкиКомпоновщика = ГенераторFixtures.КомпоновщикНастроекКомпоновкиДанных.Настройки.Отбор;
	
	
	Макет = Новый ТабличныйДокумент;
	Макет.Прочитать(ПутьУПустомуПравильномуМакету);
	ГенераторFixtures.СоздатьМакетДанныхПоМетаданным(Макет);
	
	Макет.Показать("Справочник." + Вид);
	
	ФормаГенератора.Закрыть();
	ГенераторFixtures = Неопределено;
	
	Возврат Макет;
	
КонецФункции	

Процедура ПолучитьFixturesДляСправочников(ТаблицаОбъектов)
	
	ФайлГенератораfixtures = Новый Файл(ПутьКГенераторуFixtures);
	Если Не ФайлГенератораfixtures.Существует() Тогда
		Сообщить("Не найден файл генератора Fixtures.");
		Возврат;
	КонецЕсли;	 

	
	ТаблицаВидов = ПолучитьТаблицуВидовСправочников(ТаблицаОбъектов);
	
	Для каждого СтрТаблицаВидов Из ТаблицаВидов Цикл
		ОбработкаПрерыванияПользователя();
		
		Вид = СтрТаблицаВидов.Вид;
		
		Макет = ПолучитьМакетДляВидаСправочника(Вид,ТаблицаОбъектов);
		
		//Прервать;
	КонецЦикла;
КонецПроцедуры

Процедура СделатьСообщение(Стр);
	Сообщить(Стр);
КонецПроцедуры

Процедура ВыполнитьКомандуОС(Стр)
	КомандаСистемы(Стр);
	//СистемнаяИнформация = Новый СистемнаяИнформация;
	//
	//Если (СистемнаяИнформация.ТипПлатформы = ТипПлатформы.Windows_x86) или (СистемнаяИнформация.ТипПлатформы = ТипПлатформы.Windows_x86_64) Тогда
	//	Попытка
	//		ИмяВременногоBAT = ПолучитьИмяВременногоФайла("cmd");
	//		
	//		//ЗТ = Новый ЗаписьТекста(ИмяВременногоBAT,"UTF-8",,Истина); 
	//		ЗТ = Новый ЗаписьТекста(ИмяВременногоBAT,"UTF-8",,Истина); 
	//		ЗТ.ЗаписатьСтроку(Стр); 
	//		ЗТ.Закрыть();
	//		
	//		WshShell = Новый COMОбъект("WScript.Shell");
	//		//Сообщить(Стр);
	//		WshShell.Run(ИмяВременногоBAT,7,-1);	
	//		УдалитьФайлы(ИмяВременногоBAT);
	//	Исключение
	//		#Если Клиент Тогда
	//		КомандаСистемы(Стр);
	//		#КонецЕсли
	//	КонецПопытки;
	//Иначе
	//	ВызватьИсключение "Команда системы реализована только под Windows.";
	//КонецЕсли;	 
	
КонецПроцедуры


Функция РаспаковатьEPF(ИмяФайла,КаталогРаспаковки)
	ФайлПрекомит = Новый Файл(ПутьКPrecommit);
	Если НЕ ФайлПрекомит.Существует() Тогда
		Сообщить("Не найден каталог прекоммита!");
		Возврат Ложь;
	КонецЕсли;	 

	
	ГенерироватьУФ       = Ложь;
	КаталогИнструментов  = ПутьКPrecommit;
	ЭтоУФ                = Ложь;
	Попытка
		
		Файл = Новый Файл(ИмяФайла);
		
		//ИмяКаталогаДляИсходников = Файл.Путь + "Src";
		ИмяКаталогаДляИсходников = КаталогРаспаковки;
		
		Если ГенерироватьУФ Тогда
			ПутьКФайлуМодуля = ИмяКаталогаДляИсходников + "\" + Файл.ИмяБезРасширения + "\Form\Форма\Форма.txt";
		Иначе	
			ПутьКФайлуМодуля = ИмяКаталогаДляИсходников + "\" + Файл.ИмяБезРасширения + "\ObjectModule.txt";
		КонецЕсли;	 
		
		
		
		//ИмяКаталогаДляИсходников = КаталогВременныхФайлов() + "\src";
		
		
		УдалитьФайлы(ИмяКаталогаДляИсходников + "\" + Файл.ИмяБезРасширения);
		ФайлКаталогSrc = Новый Файл(ИмяКаталогаДляИсходников);
		Если Не ФайлКаталогSrc.Существует() Тогда
			СоздатьКаталог(ИмяКаталогаДляИсходников);
		КонецЕсли;	 
		
		СтрокаРазборкиEpf = "python " + КаталогИнструментов + "\pyv8unpack.py  """ +  ИмяФайла + """ """ + ИмяКаталогаДляИсходников + """";
		СделатьСообщение("Делаю распаковку " + Файл.ПолноеИмя);
		СделатьСообщение("Строка распаковки: " + СтрокаРазборкиEpf);
		//КомандаСистемы(СтрокаРазборкиEpf,КаталогИнструментов);
		ВыполнитьКомандуОС(СтрокаРазборкиEpf);
		
		
		//Файл = Новый Файл(ПутьКФайлуМодуля);
		//Если Не Файл.Существует() Тогда
		//	СделатьСообщение("Не найден файл после распаковки: " + ПутьКФайлуМодуля);
		//	Если ЭтоУФ Тогда
		//		СделатьСообщение("Возможно это обработка для обычных форм, а не для управляемых форм.");
		//	Иначе	
		//		СделатьСообщение("Возможно это обработка для управляемых форм, а не для обычных форм.");
		//	КонецЕсли;	 
		//	Возврат Ложь;
		//КонецЕсли;	 
		
		
	Исключение
		СделатьСообщение("Не смог распаковать " + ИмяФайла);
		СделатьСообщение(ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
	Возврат Истина;
КонецФункции

Процедура УбратьЗаменитьЗапрещенныеСимволыИзСтроки(Стр) 
	Стр = СтрЗаменить(Стр,".","_");
	Стр = СтрЗаменить(Стр,",","");
	Стр = СтрЗаменить(Стр,":","");
	Стр = СтрЗаменить(Стр,";","");
	Стр = СтрЗаменить(Стр,"-","_");
	Стр = СтрЗаменить(Стр,"+","");
	//Стр = СтрЗаменить(Стр,"<","");
	//Стр = СтрЗаменить(Стр,">","");
КонецПроцедуры


Процедура ЗаписатьМакетСПравильнымИменем(ИмяМакета,Макет,КаталогДляРаботы,ИДМакета)
		УбратьЗаменитьЗапрещенныеСимволыИзСтроки(ИмяМакета);
		
		УИД = Новый УникальныйИдентификатор;
		//Сообщить("ПРОИСХОДИТ ПОДМЕНА УИД!!! ПОТОМ УБРАТЬ!!!");
		//УИД = "7a3e66f5-c873-4e1b-9d97-2c5359d503a9";
		УИД = СокрЛП(УИД);
		
		ИДМакета = УИД;
		
		ИмяФайлаОписанияМакета = КаталогДляРаботы + "\" + УИД;
		
		ЗТ = Новый ЗаписьТекста(ИмяФайлаОписанияМакета,"UTF-8",,Истина); 
		ЗТ.ЗаписатьСтроку("{1,"); 
		ЗТ.ЗаписатьСтроку("{2,0,"); 
		ЗТ.ЗаписатьСтроку("{1,"); 
		ЗТ.ЗаписатьСтроку("{0,0," + УИД + "},""" + ИмяМакета + ""","); 
		ЗТ.ЗаписатьСтроку("{1,""ru"",""" + ИмяМакета + """},"""",0,0}"); 
		ЗТ.ЗаписатьСтроку("},0}"); 
		
		ЗТ.Закрыть();
		
		Сообщить("Записал описание макета " + ИмяФайлаОписанияМакета);
		
		
		ФайлТелоМакета = КаталогДляРаботы + "\" + УИД + ".0";
		//Макет = Новый ТабличныйДокумент;
		Макет.Записать(ФайлТелоМакета);
КонецПроцедуры

Функция ПолучитьИмяФайлаRoot(КаталогДляРаботы)
	
	СтрокаВозврата = Неопределено;
	
	ИмяФайла = КаталогДляРаботы + "\root";
	ФайлПроверкаСуществования = Новый Файл(ИмяФайла);
	Если НЕ ФайлПроверкаСуществования.Существует() Тогда
		Сообщить("Файл " + ИмяФайла + " не существует!");
		Возврат Неопределено;
	КонецЕсли;	 
	
	Текст = Новый ЧтениеТекста;
	Текст.Открыть(ИмяФайла,"UTF-8");
	
	Пока Истина Цикл
		Стр = Текст.ПрочитатьСтроку();
		Если Стр = Неопределено Тогда
			Прервать;
		КонецЕсли;	 
		
		Стр = Сред(Стр,4);
		Стр = Лев(Стр,СтрДлина(Стр)-2);
		//Сообщить(Стр);
		
		СтрокаВозврата = Стр;
	КонецЦикла;	
	
	Текст.Закрыть();
	
	
	Возврат СтрокаВозврата;
КонецФункции	

Процедура ЗаписатьВФайлRootИДМакетов(ПутьКRoot,МассивМакетовДляВставки)
	Текст = Новый ЧтениеТекста;
	Текст.Открыть(ПутьКRoot,"UTF-8");
	
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла("txt");
	ЗТ = Новый ЗаписьТекста(ИмяВременногоФайла,"UTF-8",,Истина); 
	
	СтрокаДляИДМакетов = "{3daea016-69b7-4ed4-9453-127911372fe6,";
	
	Пока Истина Цикл
		Стр = Текст.ПрочитатьСтроку();
		Если Стр = Неопределено Тогда
			Прервать;
		КонецЕсли;	 
		
		Если Найти(Стр,СтрокаДляИДМакетов) > 0 Тогда
			//это строка в которой лежат макеты
			СтрокаДляИДМакетов = СтрокаДляИДМакетов + СтрЗаменить(СокрЛП(МассивМакетовДляВставки.Количество()),Символы.НПП,"");
			Для каждого Элем Из МассивМакетовДляВставки Цикл
				ИдМакета = Элем.ИдМакета;
				СтрокаДляИДМакетов = СтрокаДляИДМакетов + "," + ИдМакета;
			КонецЦикла;
			СтрокаДляИДМакетов = СтрокаДляИДМакетов + "},";
			
			Стр                = СтрокаДляИДМакетов;
		КонецЕсли;	 
		
		ЗТ.ЗаписатьСтроку(Стр); 
	КонецЦикла;	
	
	
	
	Текст.Закрыть();
	ЗТ.Закрыть();
	
	//Сообщить("Записал " + ИмяВременногоФайла);
	
	КопироватьФайл(ИмяВременногоФайла,ПутьКRoot);
	
	
КонецПроцедуры

Процедура ДобавитьСтрокиВФайлRenames(ПтуьКRenames,МассивМакетовДляВставки)
	ЗТ = Новый ЗаписьТекста(ПтуьКRenames,"UTF-8",,Истина); 
	
	Для каждого Элем Из МассивМакетовДляВставки Цикл
		ЗТ.ЗаписатьСтроку(Элем.ИдМакета + "-->und\" + Элем.ИдМакета); 
		ЗТ.ЗаписатьСтроку(Элем.ИдМакета + ".0-->Макеты\" + Элем.ИмяМакета + ".mxl"); 
		ЗТ.ЗаписатьСтроку(Элем.ИдМакета + ".0-->und\" + Элем.ИдМакета + ".0"); 
	КонецЦикла;
	
	ЗТ.Закрыть();
	
КонецПроцедуры

Процедура СкопироватьФайлыМакетовВСлужебныйКаталог(КудаСкопироватьМакеты,МассивМакетовДляВставки)
	ФайлПроверкаСуществования = Новый Файл(КудаСкопироватьМакеты);
	Если НЕ ФайлПроверкаСуществования.Существует() Тогда
		СоздатьКаталог(КудаСкопироватьМакеты);
	КонецЕсли;	 
	
	
	Для каждого Элем Из МассивМакетовДляВставки Цикл
		Макет = Элем.Макет;
		//Макет = Новый ТабличныйДокумент;
		Макет.Записать(КудаСкопироватьМакеты + "\" + Элем.ИмяМакета + ".mxl");
	КонецЦикла;
КонецПроцедуры

Процедура ДобавитьМассивмакетовОВОбработку(МассивМакетовДляВставки,ПутьКОбработке)
	ФайлОбработки  = Новый Файл(ПутьКОбработке);
	Если НЕ ФайлОбработки.Существует() Тогда
		Сообщить("Файл " + ПутьКОбработке + " не найден.");
		Возврат;
	КонецЕсли;	 
	
	
	
	КаталогРаспаковки = "C:\Temp\111";
	//КаталогДляРаботы    = ФайлОбработки.Путь + "Src\" + ФайлОбработки.ИмяБезРасширения + "\und";
	КаталогДляРаботы    = КаталогРаспаковки + "\" + ФайлОбработки.ИмяБезРасширения +  "\und";
	//ПутьКИсходникам     = ФайлОбработки.Путь + "Src\" + ФайлОбработки.ИмяБезРасширения;
	ПутьКИсходникам     = КаталогРаспаковки + "\" +  ФайлОбработки.ИмяБезРасширения;
	КаталогИнструментов = ПутьКPrecommit;
	
	ИмяВременнойEPF     = "c:\temp\111.epf";
	УдалитьФайлы(ИмяВременнойEPF);
	
	
	
	
	//СтрокаСборкиEpf = "python " + КаталогИнструментов + "\pyv8unpack.py --compile """ +  ПутьКИсходникам  + """ """ + ИмяВременнойEPF + """";
	//Сообщить("СтрокаСборкиEpf="+СтрокаСборкиEpf);
	//ВыполнитьКомандуОС(СтрокаСборкиEpf);
	//Сообщить("ПОТОМ ВЕРНУТЬ СОЗДАНИЕ EPF С МАКЕТАМИ!!!!!!!!!!!!!!!");
	//Возврат;
	
	
	Если НЕ РаспаковатьEPF(ПутьКОбработке,КаталогРаспаковки) Тогда
		Возврат;
	КонецЕсли;	 
	
	//Возврат;
	
	
	Для каждого Элем Из МассивМакетовДляВставки Цикл
		ИмяМакета = Элем.ИмяМакета;
		УбратьЗаменитьЗапрещенныеСимволыИзСтроки(ИмяМакета);
		Элем.ИмяМакета = ИмяМакета;
	КонецЦикла;
	
	
	//Возврат;
	//Сообщить("ПОТОМ ВЕРНУТЬ РАСПАКОВКУ!!!!!!!!!!!!!!!");
	
	
	
	
	//СтрокаСборкиEpf = "python " + КаталогИнструментов + "\pyv8unpack.py --compile """ +  ПутьКИсходникам  + """ """ + ИмяВременнойEPF + """";
	//Сообщить("СтрокаСборкиEpf="+СтрокаСборкиEpf);
	//ВыполнитьКомандуОС(СтрокаСборкиEpf);
	//Сообщить("ПОТОМ ВЕРНУТЬ СОЗДАНИЕ EPF С МАКТАМИ!!!!!!!!!!!!!!!");
	//Возврат;
	
	
	Для каждого Элем Из МассивМакетовДляВставки Цикл
		ИмяМакета = Элем.ИмяМакета;
		Макет     = Элем.Макет;
		ИДМакета  = "";
		ЗаписатьМакетСПравильнымИменем(ИмяМакета,Макет,КаталогДляРаботы,ИДМакета);
		Элем.Вставить("ИДМакета",ИДМакета);
	КонецЦикла;
	
	ИмяФайлаRoot = ПолучитьИмяФайлаRoot(КаталогДляРаботы);
	Если ИмяФайлаRoot = Неопределено Тогда
		Сообщить("Не смог прочитать файл root.");
		Возврат;
	КонецЕсли;	
	
	ПутьКRoot = КаталогДляРаботы + "\" + ИмяФайлаRoot;
	ЗаписатьВФайлRootИДМакетов(ПутьКRoot,МассивМакетовДляВставки);
	
	ПтуьКRenames = ПутьКИсходникам + "\renames.txt";
	ДобавитьСтрокиВФайлRenames(ПтуьКRenames,МассивМакетовДляВставки);
	
	КудаСкопироватьМакеты = ПутьКИсходникам + "\Макеты";
	СкопироватьФайлыМакетовВСлужебныйКаталог(КудаСкопироватьМакеты,МассивМакетовДляВставки);
	
	СтрокаСборкиEpf = "python " + КаталогИнструментов + "\pyv8unpack.py --compile """ +  ПутьКИсходникам  + """ """ + ИмяВременнойEPF + """";
	Сообщить("СтрокаСборкиEpf="+СтрокаСборкиEpf);
	
	ВыполнитьКомандуОС(СтрокаСборкиEpf);
	
КонецПроцедуры


Процедура ОсновныеДействияФормыТестРаспаковки(Кнопка)
	МассивМакетовДляВставки = Новый Массив;
	ТД = Новый ТабличныйДокумент;
	ТД.Прочитать("C:\Temp\Справочник.ШаблонПисем.mxl");
	
	СтруктураМакета = Новый Структура;
	СтруктураМакета.Вставить("Макет",ТД);
	СтруктураМакета.Вставить("ИмяМакета","Справочник.ШаблонПисем");
	
	МассивМакетовДляВставки.Добавить(СтруктураМакета);
	
	ПутьКОбработке = "C:\Commons\Rep\vanessa-BaseInit\ШаблонОбработкиДляНачальногоЗаполнения.epf";
	
	ДобавитьМассивмакетовОВОбработку(МассивМакетовДляВставки,ПутьКОбработке);
	
КонецПроцедуры


Процедура ПриОткрытии()
	Если ПутьКГенераторуFixtures = "" Тогда
		ПутьКГенераторуFixtures = "C:\Commons\Rep\xUnitFor1C\xddDataFixtureGen.epf";
	КонецЕсли;	 
	Если ПутьКPrecommit = "" Тогда
		ПутьКPrecommit = "C:\Commons\Rep\vanessa-base-init\.git\hooks";
	КонецЕсли;	 
	Если ПутьУПустомуПравильномуМакету = "" Тогда
		ПутьУПустомуПравильномуМакету = "C:\Commons\Rep\vanessa-base-init\ПустойПравильныйМакет.mxl";
	КонецЕсли;	 
КонецПроцедуры

//Сообщить("111  " + Метаданные.ОсновнойЯзык);
//Макет = Новый ТабличныйДокумент;
//Макет.Прочитать("c:\users\pautov\desktop\444.mxl");
//Макет.Показать();
//ыа = 1;
//Макет.КодЯзыкаМакета = Метаданные.ОсновнойЯзык.КодЯзыка;
//Макет.Показать();
//Макет.Записать("c:\users\pautov\desktop\333.mxl");
//ыва = 1;

//Метаданные.ОсновнойЯзык.КодЯзыка






